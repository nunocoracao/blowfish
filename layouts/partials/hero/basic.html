{{ $disableImageOptimization := .Page.Site.Params.disableImageOptimization | default false }}

{{ $featured := "" }}
{{ $featuredURL := "" }}
{{ if .Params.featureimage }}
  {{ $url := .Params.featureimage }}
  {{ if or (strings.HasPrefix $url "http:") (strings.HasPrefix $url "https:") }}
    {{ $featured = resources.GetRemote $url }}
  {{ else }}
    {{ $featured = resources.Get $url }}
  {{ end }}
{{ end }}

{{ if not $featured }}
  {{ $images := $.Resources.ByType "image" }}
  {{ range slice "*background*" "*feature*" "*cover*" "*thumbnail*" }}
    {{ if not $featured }}{{ $featured = $images.GetMatch . }}{{ end }}
  {{ end }}
{{ end }}

{{ if not $featured }}
  {{ with .Site.Params.defaultBackgroundImage }}
    {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
      {{ $featured = resources.GetRemote . }}
    {{ else }}
      {{ $featured = resources.Get . }}
    {{ end }}
  {{ end }}
{{ end }}

{{ with $featured }}
  {{ $featuredURL = .RelPermalink }}
  {{ if not (or $disableImageOptimization (eq .MediaType.SubType "svg")) }}
    {{ $size := (print ($.Site.Params.backgroundImageWidth | default "1200") "x") }}
    {{ $featuredURL = (.Resize $size).RelPermalink }}
  {{ end }}
{{ end }}

{{ with $featuredURL }}
  <div class="overflow-hidden h-36 md:h-56 lg:h-72">
    <img
      src="{{ . }}"
      alt="{{ $.Title }}"
      loading="eager"
      decoding="async"
      fetchpriority="high"
      class="w-full h-full nozoom object-cover">
  </div>
{{ end }}
