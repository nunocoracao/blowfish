{{ $blurId := .blurId }}
{{ $imageId := .imageId }}
{{ $imageURL := .imageURL }}
{{ $hasDiv := .hasDiv | default false }}
{{ $classes := .classes | default "" }}
{{ $scrollDivisor := .scrollDivisor | default 300 }}

{{ if $hasDiv }}
  <div id="{{ $blurId }}" {{ with $classes }}class="{{ . }}"{{ end }}></div>
{{ end }}

<script>
  (function() {
    const blurId = "{{ $blurId }}";
    const blurElement = document.getElementById(blurId);
    const imgURL = "{{ $imageURL }}"
    const imageElement = document.getElementById("{{ $imageId }}");
    const scrollDivisor = Number({{ $scrollDivisor }});
    const imageStyle = `background-image:url({{ $imageURL }});`

    const isA11yMode = () => {
      return localStorage.getItem("a11yMode") === "true";
    };

    const getScrollOpacity = () => {
      const scrollY = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
      return scrollY / scrollDivisor;
    };

    const applyBlurState = () => {
      const isA11y = isA11yMode();

      if (blurElement) {
        blurElement.style.display = isA11y ? 'none' : '';
        blurElement.style.opacity = isA11y ? '0' : getScrollOpacity();
      }

      if (imageElement) {
        const styleValue = isA11y ? 'background-image: none;' : imageStyle;
        imageElement.setAttribute('style', styleValue);
      }
    };

    applyBlurState();

    if (blurElement) {
      window.addEventListener("scroll", () => {
        if (!isA11yMode()) {
          blurElement.style.opacity = getScrollOpacity();
        }
      });
    }

    window.toggleA11yMode = function() {
      localStorage.setItem("a11yMode", String(!isA11yMode()));
      applyBlurState();
    };
  })();
</script>
